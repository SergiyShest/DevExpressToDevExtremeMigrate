@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
	Layout = "_Layout";
}


<div style="display:flex;flex-direction:column;align-items:flex-start;align-content:flex-start;align-self:stretch">
	<h1></h1>

	<div id="app" style="display: flex;flex-direction: column;width: 450px;">
		<div style="display: flex;align-items:center">
			<div style="width: 100px;margin-left:15px">Дата:</div>
			oт<input id="d1From" type="date" v-model="from" style="margin:3px">
			до<input id="d1To" type="date" v-model="to" style="margin:3px">
			<kf-button id="findButton"  v-if="mode!='view'" v-on:click.native="FindDate" text="Найти" image="find"></kf-button>
		</div>

		<div style="display:flex;flex-direction:row;">
			<kf-button id="addButton" v-if="mode!='view'"		v-on:click.native="AddClick"	text="Добавить"			image="add"></kf-button>
			<kf-button id="editButton" v-if="mode!='view'"		v-on:click.native="EditClick"	text="Редактировать"	image="edit"></kf-button>
			<kf-button id="copyButton" v-if="mode!='view'"		v-on:click.native="CopyClick"	text="Копировать"		image="copy"></kf-button>
			<kf-button id="deleteButton" v-if="mode!='view'"	v-on:click.native="DeleteClick"	text="Удалить"			image="delete"></kf-button>
		</div>
	</div>
	<div id="grid" />
</div>

    <script type="module">

    $(window).on("load",function () {
	@Html.Raw(TempData["StartupScript"])
		});
	 let Mode = '@ViewBag.Mode'
	 let focusedRowKey = null;
         import { KfField, KfInput, KfDate, KfSelect, KfNumber, KfCheck, KfTextarea, KfText, KfButton } from '/js/vue3Components.js';
         import { baseMixin } from '/js/BaseMixin.js';
         const { ref } = Vue;
	 function setDataSource() {
		 const dataSource = DevExpress.data.AspNet.createStore({
			 key: "Id",
			 loadUrl: document.location.origin + "/Workflow/Process/Get",
		 });
		 var grid = $("#grid").dxDataGrid("instance");
		 grid.option("dataSource", dataSource);
	 }
		function OnFocusedRowChanged(e) {
			focusedRowKey = e.component.option('focusedRowKey');
		}

	  const app = Vue.createApp({
		 mixins: [baseMixin],
		 data() {
			 return {
				 from: null,
				 to: null
			 }
		 }
		 ,
		 methods: {
			 FindDate() {
				 localStorage.setItem('dateFrom', this.from);
				 localStorage.setItem('dateTo', this.to);
				 const pathEnd = "/Workflow/Process/SetFilter";
				 const data = { from: this.from, to: this.to };
				 this.FetchJson( pathEnd,this.Ok, data)
			 },
			 Ok() {
			    setDataSource();
			 },
			AddClick() {
				xPopup ('Карточка ', '/Workflow/ProcessCard/Index' + '?page_mode=modal', 1024, 916);
			}
			,
			 EditClick() {
				if (checkItem(focusedRowKey)) {
					xPopup('Карточка ', '/Workflow/ProcessCard/Index?id=' + focusedRowKey  , 1024, 916);
				}

			},
			 CopyClick() {
				if (checkItem(focusedRowKey)) {
					   xPopup('Карточка ', '/Workflow/ProcessCard/Index?id=' + focusedRowKey + '&mode=copy', 1024, 916);
				}
			},

			 DeleteClick() {
			  if (checkItem(focusedRowKey)) {
				  path = '/Workflow/ProcessCard/Delete?id='+ focusedRowKey
				   this.FetchJson(path,this.Ok)
			  }
		  }
		 },
		 mounted: function () {

			let fr = localStorage.getItem('dateFrom');
			if (fr != 'null') this.from = fr;

			let to = localStorage.getItem('dateTo');
			if (to != 'null') this.to = to;
			
			this.FindDate()

		 }
	 });
	  // Registering components
       //  app.component('kf-field', KfField);
       app.component('kf-button', KfButton);
      //  app.component('kf-input', KfInput);
      //  app.component('kf-date', KfDate);
      //  app.component('kf-select', KfSelect);
      //  app.component('kf-number', KfNumber);
      //  app.component('kf-check', KfCheck);
      //  app.component('kf-textarea', KfTextarea);
      //  app.component('kf-text', KfText);

        // Mounting Vue app
		const vue_ = app.mount('#app');


	 function onRowClick(e) {
        var component = e.component,
            prevClickTime = component.lastClickTime;
        component.lastClickTime = new Date();
        if (prevClickTime && (component.lastClickTime - prevClickTime < 300)) {
            vue_.EditClick()
        }
    }

  $("#grid").dxDataGrid({
	    onRowClick: onRowClick,
        stateStoring: {
            storageKey: 'dkJournal_Grid',
        },
        "export": {//выгрузка в excel
            enabled: true,
            fileName: "Отчет ",
            allowExportSelectedData: true
        },
        focusedRowEnabled: true,
        onFocusedRowChanged: OnFocusedRowChanged,

        columns:[{caption:'caption',
dataField:'fieldName',
dataType:'text',
 width:'16px',
}
,
{caption:'Id',
dataField:'Id',
dataType:'text',
 width:'20px',
visible:false,
}
,
{caption:'Html.GetLocalizedText<ViewModelFields>(nameof(ViewModelFields.Sample_Barcode))',
dataField:'SampleBookRecord.Barcode',
dataType:'text',
 width:'50px',
}
,
{caption:'Html.GetLocalizedText<ViewModelFields>(nameof(ViewModelFields.Sample_Name))',
dataField:'SampleBookRecord.Name',
dataType:'text',
 width:'50px',
}
,
{caption:'Html.GetLocalizedText<ViewModelFields>(nameof(ViewModelFields.Sample_Location))',
dataField:'SampleBookRecord.Location',
dataType:'text',
 width:'100px',
}
,
{caption:'Html.GetLocalizedText<ViewModelFields>(nameof(ViewModelFields.Sample_Box))',
dataField:'SampleBookRecord.BatchName',
dataType:'text',
 width:'100px',
}
,
{caption:'Html.GetLocalizedText<ViewModelFields>(nameof(ViewModelFields.Sample_Well))',
dataField:'Sample.Record.Well',
dataType:'text',
}
,
{caption:'Html.GetLocalizedText<ViewModelFields>(nameof(ViewModelFields.Sample_Process))',
dataField:'SampleBookRecord.ProcessName',
dataType:'text',
}
,
{caption:'Html.GetLocalizedText<ViewModelFields>(nameof(ViewModelFields.Sample_User))',
dataField:'SampleBookRecord.UserName',
dataType:'text',
}
,
{caption:'Sample Id',
dataField:'SampleId',
dataType:'text',
visible:false,
}
,
{caption:'SampleBookRecord.Patient',
dataField:'SampleBookRecord.Patient',
dataType:'text',
}
,
{caption:'SampleBookRecord.Doctor',
dataField:'SampleBookRecord.Doctor',
dataType:'text',
}
]

    });

</script>
