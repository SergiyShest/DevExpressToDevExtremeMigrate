@using Sasha.Lims.WebUI.Models
@using System.Web.UI.WebControls
@using Sasha.Lims.WebUI.Controllers
@using Sasha.Lims.WebUI.Infrastructure.ViewModelHelpers

@{
	GridBasedController controller = ViewContext.Controller as GridBasedController;
	const string ControllerName = "Reagents";
	//int samplesCount = (int)ViewBag.SamplesCount;
	var gridView = Html.DevExpress().GridView( settings => {
		settings.Name = controller.GetGridViewName();
		settings.Width = Unit.Percentage(100);

		settings.Settings.VerticalScrollBarMode = ScrollBarMode.Hidden;
		settings.Settings.HorizontalScrollBarMode = ScrollBarMode.Auto;
		settings.SettingsResizing.ColumnResizeMode = ColumnResizeMode.Control;
		settings.SettingsResizing.Visualization = ResizingMode.Postponed;

		settings.SettingsBehavior.ProcessColumnMoveOnClient = false;
		settings.SettingsBehavior.ColumnMoveMode = GridColumnMoveMode.AmongSiblings;
		settings.SettingsBehavior.EnableCustomizationWindow = true;
		settings.SettingsCookies.Enabled = true;
		settings.SettingsCookies.StoreColumnsVisiblePosition = true;
		settings.SettingsCookies.StoreColumnsWidth = true;
		settings.SettingsCookies.StoreControlWidth = false;
		settings.SettingsCookies.StoreFiltering = true;
		settings.SettingsCookies.StorePaging = false;
		settings.SettingsCookies.StoreColumnsHierarchy = false;
		settings.SettingsCookies.StoreFiltering = false;
		settings.Settings.ShowGroupPanel = false;

		settings.SettingsBehavior.AllowFocusedRow = true;
		settings.SettingsBehavior.AllowSelectByRowClick = false;
		settings.SettingsBehavior.AllowEllipsisInText = true;
		settings.SettingsBehavior.AllowDragDrop = true;


		settings.SettingsPager.Visible = true;
		settings.Styles.PagerBottomPanel.HorizontalAlign = HorizontalAlign.Right;
		settings.SettingsPager.Position = PagerPosition.Bottom;
		settings.SettingsPager.Summary.Visible = false;

		settings.Settings.ShowFilterRow = true;
		settings.Settings.ShowFilterRowMenu = true;
		settings.SettingsBehavior.FilterRowMode = GridViewFilterRowMode.Auto;


		ReagentViewModel vm = null; // compiler needs just type info, not the value

		settings.Columns.AddColumnForVmField(vm, m => m.BarCode);
		settings.Columns.AddColumnForVmField(vm, m => m.VendorId);
		settings.Columns.AddColumnForVmField(vm, m => m.Name);
		settings.Columns.AddColumnForVmField(vm, m => m.CatalogNumber);
		settings.Columns.AddColumnForVmField(vm, m => m.KitTypeId);
		settings.Columns.AddColumnForVmField(vm, m => m.Quantity);
		settings.Columns.AddColumnForVmField(vm, m => m.UnitId);
		settings.Columns.AddColumnForVmField(vm, m => m.StorageTempId);
		foreach(var c in controller.CustomFields)
			settings.Columns.AddColumnForMetadata(c);

		settings.CustomJSProperties = (sender, e) =>
		{
			var grid = sender as MVCxGridView;
			e.Properties["cpRowCount"] = grid.VisibleRowCount;

			if (ViewData["EditError"] != null)
				e.Properties["cpEditError"] = ViewData["EditError"];
		};

		settings.SettingsPopup.HeaderFilter.Height = Unit.Pixel(440);
		settings.SettingsPopup.HeaderFilter.Width = Unit.Pixel(360);
		settings.SettingsPopup.HeaderFilter.SettingsAdaptivity.Mode = PopupControlAdaptivityMode.OnWindowInnerWidth;
		settings.SettingsPopup.HeaderFilter.SettingsAdaptivity.SwitchAtWindowInnerWidth = 768;

		//Command columns settings
		settings.CommandColumn.Visible = true;
		settings.CommandColumn.ShowSelectCheckbox = true;
		settings.CommandColumn.SelectAllCheckboxMode = GridViewSelectAllCheckBoxMode.Page;
		settings.CommandColumn.VisibleIndex = 0;
		settings.CommandColumn.Width = Unit.Pixel(52);

		settings.SettingsContextMenu.EnableRowMenu = DefaultBoolean.False;

		//Handles standard grid callback requests.
		settings.CallbackRouteValues = new { Controller = ControllerName, Action = "GridViewPartial" };
		settings.SettingsEditing.AddNewRowRouteValues = new { Controller = ControllerName, Action = "GridViewPartialAddNew" };
		settings.SettingsEditing.UpdateRowRouteValues = new { Controller = ControllerName, Action = "GridViewPartialUpdate" };

		settings.SettingsEditing.Mode = GridViewEditingMode.PopupEditForm;
		settings.SettingsEditing.EditFormColumnCount = 2;
		settings.SettingsPopup.EditForm.SettingsAdaptivity.MaxWidth = 800;
		settings.SettingsPopup.EditForm.SettingsAdaptivity.Mode = PopupControlAdaptivityMode.Always;
		settings.SettingsPopup.EditForm.SettingsAdaptivity.VerticalAlign = PopupAdaptiveVerticalAlign.WindowCenter;

		settings.SetEditFormTemplateContent(c => Html.RenderAction("DetailsPartial", ControllerName, new { id = DataBinder.Eval(c.DataItem, "Id") }) );

		//Handles grid data operations - in this sample, paging and sorting.
		settings.CustomBindingRouteValuesCollection.Add(GridViewOperationType.Paging, new { Controller = ControllerName, Action = "GridViewPagingAction" });
		settings.CustomBindingRouteValuesCollection.Add(GridViewOperationType.Sorting, new { Controller = ControllerName, Action = "GridViewSortingAction" });
		settings.CustomBindingRouteValuesCollection.Add(GridViewOperationType.Filtering, new { Controller = ControllerName, Action = "GridViewFilteringAction" });

		settings.CustomActionRouteValues = new { Controller = ControllerName, Action = "GridViewCustomAction" };

		//Select checkbox enabled
		settings.CommandButtonInitialize = (sender, e) =>
		{
			if (e.VisibleIndex == -1) return;
			if (e.ButtonType == ColumnCommandButtonType.SelectCheckbox)
			{
				var enabled = true;
				e.Visible = enabled;
				e.Enabled = enabled;
			}
		};

		settings.SettingsDataSecurity.AllowReadUnlistedFieldsFromClientApi = DefaultBoolean.True;

		settings.ClientSideEvents.Init = "onGridViewInit";
		settings.ClientSideEvents.SelectionChanged = "onGridViewSelectionChanged";
		settings.ClientSideEvents.BeginCallback = "onGridViewBeginCallback";
		settings.ClientSideEvents.EndCallback = "onGridViewEndCallback";
		//settings.ClientSideEvents.RowDblClick = "onRowDblClick";
		settings.ClientSideEvents.ColumnResized = "function(s, e) {	e.processOnServer = true; }"; // force event to save cookie
		settings.ClientSideEvents.CustomizationWindowCloseUp = "onGridCustomizationWindowCloseUp";
	});
}

@gridView.BindToCustomData(Model).GetHtml()
